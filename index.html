<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>金馬鴻運聚福堂 - 崇正寶宮靈籤</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- html2canvas CDN -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- QRCode Generator CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
        
        :root {
            --wood-base: #a52a2a;
            --wood-dark: #5d1a1a;
            --gold-glow: #fbbf24;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            margin: 0;
            padding: 0;
            background-color: #2d0a0a;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* 修正背景圖片錯誤：改用內聯 SVG */
        .paper-texture {
            background-color: #fcfaf2;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }

        .gate-stud {
            width: clamp(10px, 2.5vw, 14px);
            height: clamp(10px, 2.5vw, 14px);
            background: radial-gradient(circle at 35% 35%, #fbbf24, #b45309);
            border-radius: 50%;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.7);
        }

        .gate-perspective {
            perspective: 2000px;
            overflow: hidden;
        }

        @keyframes swing-left {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(-115deg); }
        }
        @keyframes swing-right {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(115deg); }
        }
        
        .animate-swing-left { 
            transform-origin: left;
            animation: swing-left 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; 
            animation-delay: 0.2s;
        }
        .animate-swing-right { 
            transform-origin: right;
            animation: swing-right 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; 
            animation-delay: 0.2s;
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(10px, -15px); }
            100% { transform: translate(0, 0); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
        
        .wood-texture {
            background-color: var(--wood-base);
            background-image: repeating-linear-gradient(
                90deg,
                rgba(0,0,0,0.2) 0px,
                rgba(0,0,0,0.2) 2px,
                transparent 2px,
                transparent 50px,
                rgba(255,255,255,0.05) 50px,
                rgba(255,255,255,0.05) 52px
            );
            box-shadow: inset 0 0 120px rgba(0,0,0,0.7);
        }

        .seal-font {
            font-size: 28px;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: 0.05em;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // QR Code 組件
        const QrCodeGenerator = ({ value, size = 100, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && value) {
                    try {
                        const qr = qrcode(0, 'L');
                        qr.addData(value);
                        qr.make();
                        containerRef.current.innerHTML = qr.createImgTag(4, 8);
                        const img = containerRef.current.querySelector('img');
                        if (img) {
                            img.style.width = `${size}px`;
                            img.style.height = `${size}px`;
                            img.className = "rounded-sm border border-stone-200";
                        }
                    } catch (e) { console.error(e); }
                }
            }, [value, size]);
            return <div ref={containerRef} className={className} />;
        };

        const Icons = {
            ChevronLeft: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            ),
            Sparkles: ({ className }) => (
                <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
            ),
            RefreshCw: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
            ),
            Camera: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            ),
            Download: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            ),
            Volume2: () => (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5 6 9H2v6h4l5 4V5Z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
            ),
            VolumeX: () => (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5 6 9H2v6h4l5 4V5Z"/><line x1="22" y1="9" x2="16" y2="15"/><line x1="16" y1="9" x2="22" y2="15"/></svg>
            ),
            MountainLogo: ({ className }) => (
                <img 
                    src="assets/白陽山LOGO.jpg" 
                    alt="白陽山" 
                    className={className} 
                    style={{ objectFit: 'contain' }}
                    crossOrigin="anonymous"
                    onError={(e) => { e.target.style.opacity = 0; }}
                />
            ),
            CloudImage: ({ className, style }) => (
                <img src="assets/cloud.png" alt="雲朵" className={className} style={{ objectFit: 'contain', mixBlendMode: 'screen', ...style }} />
            ),
            PhotoKnocker: ({ side }) => (
                <div className={`relative flex items-center justify-center ${side === 'left' ? 'mr-[-40px]' : 'ml-[-40px]'} z-20`}>
                    <div className="w-20 h-20 md:w-24 md:h-24 rounded-full bg-red-700 border-4 border-amber-500 shadow-[0_0_20px_rgba(0,0,0,0.6)] flex items-center justify-center relative">
                        <div className="w-16 h-16 md:w-20 md:h-20 rounded-full border border-amber-600/50 shadow-inner" />
                        <div className="absolute inset-2 rounded-full bg-gradient-to-br from-white/10 to-transparent pointer-events-none" />
                    </div>
                </div>
            )
        };

        const fortuneData = {
            "1": ["欲成精金美玉品", "須向烈火焠煉真", "思立驚天動地業", "須懷慎終如始心"],
            "2": ["渡海浮囊一針差", "千里堤堰一蟻沙", "念頭雖微物縱恣", "高聳德業一夕塌"],
            "3": ["閒時常省言行合", "忙處為事自少過", "靜時常守元神住", "動中起念必不脫"],
            "4": ["世態炎涼無倚偏", "世味濃淡無欣厭", "如水隨方而就圓", "融通得體自在安"],
            "5": ["昨日之非莫留遺", "塵情必累自性地", "今日之是莫執拘", "真性反轉慾念及"],
            "6": ["建功立德踏實地", "若慕聲望業終息", "修善培福立根基", "若計功勞果終虛"],
            "7": ["由外境物而得者", "有得有失常有落", "不若向內求真實", "自得自獲更廣闊"],
            "8": ["不忍之念愛物芽", "芽發枝長蔭群娃", "喜捨之心福田根", "根深蒂固美果佳"],
            "9": ["心似明珠物慾蔽", "如混泥沙滌猶易", "塵情識神若黏附", "如飾銀黃滌何去"],
            "10": ["垢病易察無憂治", "潔病難察恐無治", "事障易視無愁滯", "理障難視恐留滯"],
            "11": ["生來死去有歸無", "何人視透向道途", "因緣果報早已註", "積功培德勤力篤"],
            "12": ["九死一生出鬼關", "猛然覺醒回頭岸"],
            "13": ["轉又轉唷打陀螺", "何時停歇何時落", "萬般皆有因與果", "智慧之者早跳脫"],
            "14": ["操守須有真主宰", "遇事穩固不搖擺"],
            "15": ["因人啟覺而悟者", "有悟尚還有迷惑", "不若自心定靜省", "自覺自悟力行作"],
            "16": ["化得家中嫌隙雪", "手足同心力和協", "父慈子孝萬事興", "攜手向道歡喜悅"],
            "17": ["一念謬差毀前善", "半世功名百世冤", "謹言慎行戰兢前", "參透修道是本源"],
            "18": ["夭壽窮通各不一", "各人運途各人趨", "轉運改命由自己", "修道為本早上梯"],
            "19": ["清風明月翠松竹", "粗衣淡飯自在處", "虛其心而實其腹", "不憂利祿與榮辱"],
            "20": ["皮囊有盡氣數限", "明了之者緊向前", "名利浮雲終消散", "放下無拘自在安"],
            "21": ["浮華聲色蔽心目", "主人反受僕役奴", "懸崖邊緣競相逐", "慧眼速睜脫束縛"],
            "22": ["聲色障礙成聾啞", "昏昏暗暗如何察", "一盞智燈破痴傻", "循序漸進聖域達"],
            "23": ["數粒充腸亦果腹", "名利充腸何時足", "墨水充腸言暢舒", "道義充腸自如如"],
            "24": ["求佛拜佛口念佛", "真佛在前識不破", "非是眼前障礙多", "十惡八邪將心鎖"],
            "25": ["說三道四爛腐舌", "滿腹人非養毒蛇", "傷得人家亦害己", "不若內修緘口舌"],
            "26": ["行善莫謂身無錢", "一旦病來費萬千", "早行功來早保命", "莫等命休早知前"],
            "27": ["閻王老無情客", "無須邀至寒舍", "縱不願亦不可", "萬貫財終必捨"],
            "28": ["黃泉路冷清清", "任至親亦獨行", "若如此何計較", "早修道登理程"],
            "29": ["點開生死匣", "不被閻君轄", "玄祖喜樂佳", "修辦腳步跨"],
            "30": ["百年好佳光", "切莫渺茫往", "如此壽亦夭", "未死已先葬"],
            "31": ["一炬火燒盡", "萬有成灰燼", "形象皆成空", "修道當殷勤"],
            "32": ["賊人偷身外物", "偷不去性佛祖", "物不在無礙阻", "樂歡喜滌雜污"],
            "33": ["洗淨世間之塵埃", "焰火寒冰心無礙", "平息眼光之鄙吝", "霽月光風時常在"],
            "34": ["閒暇之時惕惰氣", "收攝心猿暢天機", "騰達之時惕傲氣", "收斂心神禍遠避"],
            "35": ["酒色財氣四條路", "散亂本心深淵赴", "斷了智慧稟氣固", "何時跳脫何出苦"],
            "36": ["上天無親德為輔", "進德修業必不孤", "事事反求於諸己", "根基穩立功德儲"],
            "37": ["心外求佛何處得", "尋尋覓覓愈挫折", "回頭靈山修真我", "除污復顯自性佛"],
            "38": ["走馬看花一溜煙", "禪機妙訓誰參研", "前世今生早明瞭", "快向道途保身前"],
            "39": ["顛黑倒白世態遷", "誰是誰非難論全", "只求問心而無愧", "精進德業了冤愆"],
            "40": ["啞吃黃蓮苦難言", "劇本已定如何變", "家家有本難念經", "惟有修道是根源"],
            "41": ["內心清明外渾厚", "視物何有好與丑", "內心樸實外圓通", "待人何有新與舊"],
            "42": ["端品正行何勞人", "收得心住道志伸", "醍醐灌頂句句是", "牢守方寸早安頓"],
            "43": ["斬孽根脫輪迴", "了生死故都歸", "紅塵中不迷醉", "守道心凡胎蛻"],
            "44": ["菩提種植心田", "拔疑惑信心堅", "除是非治蟲害", "道義潤果碩圓"],
            "45": ["世事變如棋局", "轉眼間大勢去", "當慎思下手處", "手一起難回移"],
            "46": ["口腹欲債高築", "堆如山障運途", "暴戾氣如何除", "惟功德還清楚"],
            "47": ["世路雖繁華", "常思黃泉下", "利慾心自淡", "言行不浮誇"],
            "48": ["洗淨名利眼", "復歸菩薩顏", "淡泊富貴心", "常懷慈悲念"],
            "49": ["冰炭不同爐", "聖凡豈同路", "清濁判天淵", "修者莫自誤"],
            "50": ["有來亦有去", "只留無形機", "切莫生苦悶", "消災免禍遺"],
            "51": ["天地尚不息", "日月有損余", "人事焉圓滿", "轉念寬心地"],
            "52": ["虱蚤寄身穩如泰山", "焉知此身幻滅短暫"],
            "53": ["樹高千丈落葉歸根", "千江浪濤滴水源尋"],
            "54": ["晨昏定省體察親需", "承歡膝下色柔聲怡"],
            "55": ["夫良妻賢同心修辦", "禮正身端家齊祥安"],
            "56": ["日日忙碌卻有善根", "聞道精進更上聖門"],
            "57": ["喧囂紅塵何見佛蹤", "仁心慈腸便是佛種"],
            "58": ["雪中送炭足跡深烙", "良言善語銘刻感召"],
            "59": ["前世冤業今朝隨身", "懺前悔後但憑心誠"],
            "60": ["生得此戶死往哪住", "不得一點難返故都"],
            "61": ["居上不驕為下不亂", "在醜不爭事親孝焉"],
            "62": ["入孝出悌親身恭行", "不言而教和樂盈盈"],
            "63": ["祖德庇蔭今得聞道", "續培道苗子孫引導"],
            "64": ["父慈子孝兄友弟恭", "妯娌和睦家道昌隆"],
            "65": ["謹身節用以養父母", "安慰敬順孝親朝暮"],
            "66": ["父母之恩昊天罔極", "立身行道後世留遺"],
            "67": ["寸功寸德生前多修", "莫等死後再為骷髏"],
            "68": ["火宅修辦方便法門", "火中栽蓮莫錯良辰"],
            "69": ["烈焰之火起於玩忽", "盛開之功敗於細部"],
            "70": ["待人有餘不盡恩澤", "禦事有餘不盡智哲"],
            "71": ["苦時之坑明逝易逃", "樂處之阱難辨易掉"],
            "72": ["共邀千百人同歡聚", "不若釋一人之怨氣"],
            "73": ["肝腸煦煦猶如春風", "囊雖羞澀溫暖三冬"],
            "74": ["志節清清似如秋水", "家雖四壁更勝王威"],
            "75": ["明佔便宜暗中必虧", "貪得世味性地必頹"],
            "76": ["半瓢粟米周濟飢荒", "物雖微弱福氣久長"],
            "77": ["少不患奮患迅而莽", "老不患成患得而防"],
            "78": ["非份之福無妄之災", "禍福相倚心定莫歪"],
            "79": ["夢有干萬惟一醒來", "人有千萬惟一道栽"],
            "80": ["水注五分器便中穩", "虛欹滿覆中庸為本"],
            "81": ["果種生花花開結果", "福至有因培之必獲"],
            "82": ["飛蛾撲火火焦飛蛾", "禍生有本造之難躲"],
            "83": ["耐久之交最於貧寒", "真心相待誨己不倦"],
            "84": ["多積經書家和子賢", "常積金玉伏禍致險"],
            "85": ["塵俗鬧市更應學道", "方免隨風四處飄搖"],
            "86": ["貪得之者身富心貧", "知足之人身貧心富"],
            "87": ["眼前田地放得寬遠", "使人息卻不平之嘆"],
            "88": ["路徑窄處多留一步", "與人共行互惠互助"],
            "89": ["德業為要毋落人後", "理直氣和毋與人鬥"],
            "90": ["人情反覆世路崎嶇", "通權達變進退得體"],
            "91": ["塵中振衣哪得潔身", "奮勇跳脫臻登聖門"],
            "92": ["當面錯過咫尺千里", "故當事事專心致意"],
            "93": ["待善宜寬待惡當嚴", "待庸眾者寬嚴雙兼"],
            "94": ["世人皆以飢寒為憂", "不知心靈空乏更憂"],
            "95": ["無邊善念路無斷頭", "舉手善行緣無盡頭"],
            "96": ["懷真心百折不回", "其妙用萬變不匱"],
            "97": ["我心為巨海長江", "縱有那橫流激盪", "何患其不能廣納", "善下之成百谷王"],
            "98": ["拔草除而根不淨", "恐石去而草復興", "修缺病而氣不化", "恐理得而病復生"],
            "99": ["身在江湖不從心", "果敢放下上智人"],
            "100": ["蝸角競利終歸空", "務實修道萬八榮"],
            "101": ["縱情逐物事紛擾", "放下萬緣一步超"]
        };

        const JustifiedText = ({ text, className, style, poetryLine }) => {
            if (!text) return null;
            const chars = text.split("");
            return (
                <div className={`flex justify-between w-full select-none whitespace-nowrap ${poetryLine ? 'poetry-line' : ''} ${className}`} style={{ minWidth: '100%', ...style }}>
                    {chars.map((char, i) => <span key={i} style={{ display: 'inline-block' }}>{char}</span>)}
                </div>
            );
        };

        const MuteButton = ({ isMuted, toggleMusic }) => (
            <button onClick={toggleMusic} className="fixed top-4 right-4 z-[200] p-2 bg-black/30 rounded-full text-amber-400 hover:bg-black/50 transition-colors">
                {isMuted ? <Icons.VolumeX /> : <Icons.Volume2 />}
            </button>
        );

        const GateHalf = ({ side }) => (
            <div className={`w-1/2 h-full wood-texture border-y-8 border-black relative flex items-center shadow-[inset_0_0_80px_rgba(0,0,0,0.8)] ${side === 'left' ? 'animate-swing-left justify-end border-r-2 border-r-black/50' : 'animate-swing-right justify-start border-l-2 border-l-black/50'}`}>
                <div className="absolute inset-y-0 w-full bg-gradient-to-r from-black/20 via-transparent to-black/20 pointer-events-none" />
                <div className={`absolute inset-0 flex items-center ${side === 'left' ? 'justify-start pl-8 md:pl-16' : 'justify-end pr-8 md:pr-16'}`}>
                    <div className="grid grid-cols-2 grid-rows-3 gap-x-6 gap-y-12 md:gap-x-12 md:gap-y-20 opacity-90">
                        {Array(6).fill(0).map((_, i) => <div key={i} className="gate-stud" />)}
                    </div>
                </div>
                <Icons.PhotoKnocker side={side} />
            </div>
        );

        const App = () => {
            const [page, setPage] = useState('home');
            const [lotNumber, setLotNumber] = useState('');
            const [currentDate, setCurrentDate] = useState('');
            const [isMuted, setIsMuted] = useState(false);
            const [isDownloading, setIsDownloading] = useState(false);
            
            const audioRef = useRef(null);
            const doorAudioRef = useRef(null);
            const cardRef = useRef(null);

            useEffect(() => {
                const today = new Date();
                setCurrentDate(`${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`);
                audioRef.current = new Audio('assets/bgm.mp3');
                audioRef.current.loop = true;
                doorAudioRef.current = new Audio('https://assets.mixkit.co/active_storage/sfx/2177/2177-preview.mp3');

                const playOnFirstInteraction = () => {
                    if (audioRef.current && !isMuted) audioRef.current.play().catch(() => {});
                    window.removeEventListener('mousedown', playOnFirstInteraction);
                };
                window.addEventListener('mousedown', playOnFirstInteraction);
                return () => {
                    if (audioRef.current) audioRef.current.pause();
                    window.removeEventListener('mousedown', playOnFirstInteraction);
                };
            }, []);

            const toggleMusic = () => {
                if (!audioRef.current) return;
                isMuted ? audioRef.current.play() : audioRef.current.pause();
                setIsMuted(!isMuted);
            };

            const handleStart = () => {
                const num = parseInt(lotNumber);
                if (!lotNumber || isNaN(num) || num < 1 || num > 101) return;
                setPage('door');
                if (doorAudioRef.current && !isMuted) {
                    doorAudioRef.current.currentTime = 0;
                    doorAudioRef.current.play().catch(() => {});
                }
                setTimeout(() => setPage('result'), 2800);
            };

            const getPoem = (num) => fortuneData[parseInt(num).toString()] || ["誠心祈求靈感應", "福星高照事皆興"];

            const downloadCard = async () => {
                if (!cardRef.current || isDownloading) return;
                setIsDownloading(true);
                try {
                    const canvas = await html2canvas(cardRef.current, {
                        width: 1080,
                        height: 1920,
                        scale: 1, 
                        useCORS: true,
                        backgroundColor: "#000000",
                        onclone: (clonedDoc) => {
                            const clonedCard = clonedDoc.querySelector('[data-card-body]');
                            if (clonedCard) {
                                clonedCard.style.width = '1080px';
                                clonedCard.style.height = '1920px';
                                clonedCard.style.maxWidth = 'none';
                                clonedCard.style.borderRadius = '0'; 

                                const top = clonedCard.querySelector('.card-top');
                                if (top) top.style.padding = '180px 40px 80px 40px';
                                
                                const logo = clonedCard.querySelector('.logo-circle');
                                if (logo) { logo.style.width = '380px'; logo.style.height = '380px'; logo.style.marginBottom = '100px'; }

                                const titles = clonedCard.querySelectorAll('.title-section h2');
                                titles.forEach(h => { h.style.fontSize = '64px'; h.style.marginBottom = '30px'; });

                                const bottom = clonedCard.querySelector('.card-bottom');
                                if (bottom) bottom.style.padding = '100px 80px 140px 80px';

                                const poetryLines = clonedCard.querySelectorAll('.poetry-line');
                                poetryLines.forEach(line => { line.style.fontSize = '84px'; line.style.marginBottom = '50px'; });

                                const footer = clonedCard.querySelector('.card-footer');
                                if (footer) {
                                    footer.style.paddingTop = '100px';
                                    const dateText = footer.querySelector('.auth-date-text');
                                    if (dateText) dateText.style.fontSize = '46px';
                                    const qr = footer.querySelector('.qr-container');
                                    if (qr) qr.style.display = 'block'; // 下載時確保顯示
                                    const seal = footer.querySelector('.card-seal');
                                    if (seal) { seal.style.width = '240px'; seal.style.height = '240px'; seal.style.fontSize = '80px'; }
                                }
                            }
                        }
                    });
                    const link = document.createElement('a');
                    link.download = `崇正福卡-${lotNumber}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                } catch (err) { console.error(err); } finally { setIsDownloading(false); }
            };

            if (page === 'home') {
                return (
                    <div className="min-h-screen bg-[#2d0a0a] text-stone-200 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        <MuteButton isMuted={isMuted} toggleMusic={toggleMusic} />
                        <Icons.CloudImage className="absolute top-10 left-[-5%] w-48 opacity-40 animate-float" />
                        <div className="text-center z-10 w-full max-w-lg">
                            <h2 className="text-amber-500 text-xs tracking-[0.4em] mb-3 uppercase">Gold Horse Fortune</h2>
                            <h1 className="text-6xl md:text-8xl font-black text-white mb-2 tracking-tighter">金馬鴻運</h1>
                            <h2 className="text-4xl md:text-5xl font-bold text-amber-500 tracking-widest">聚福堂</h2>
                            <div className="mt-12 bg-black/40 p-8 rounded-2xl border border-amber-500/30 backdrop-blur-md">
                                <input type="number" value={lotNumber} onChange={(e) => setLotNumber(e.target.value)} placeholder="籤號 (1-101)" className="w-full bg-black/60 text-center text-4xl text-amber-100 focus:outline-none py-4 rounded-xl border border-amber-500/50 mb-6" />
                                <button onClick={handleStart} className="w-full bg-gradient-to-b from-[#e68a00] to-[#b35900] text-white py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                                    <Icons.Sparkles /> 開啟鴻運
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (page === 'door') return <div className="fixed inset-0 bg-black flex z-[100] gate-perspective"><GateHalf side="left" /><GateHalf side="right" /></div>;

            if (page === 'result') {
                const poem = getPoem(lotNumber);
                return (
                    <div className="min-h-screen bg-[#f4f3ed] p-4 flex flex-col items-center overflow-y-auto">
                        <MuteButton isMuted={isMuted} toggleMusic={toggleMusic} />
                        <div className="w-full max-w-lg mb-4 flex items-center"><button onClick={() => setPage('home')} className="flex items-center text-red-900 font-bold"><Icons.ChevronLeft /> 返回</button></div>
                        <div className="w-full max-w-lg bg-white rounded-xl shadow-2xl border border-stone-200 overflow-hidden mb-6">
                            <div className="h-16 bg-[#a52a2a]" />
                            <div className="p-8 flex flex-col items-center">
                                <div className="w-24 h-24 bg-white rounded-full border-4 border-amber-100 p-3 mb-6"><Icons.MountainLogo className="w-full h-full" /></div>
                                <h2 className="text-2xl font-bold text-stone-800 mb-6">靈籤第 {lotNumber} 號</h2>
                                <div className="bg-[#fdfaf2] border-l-4 border-amber-800 p-8 mb-6 w-full flex flex-col gap-3">
                                    {poem.map((line, i) => <JustifiedText key={i} text={line} className="text-2xl font-bold text-stone-900" />)}
                                </div>
                                <p className="text-stone-600 text-center text-sm">修身立德為本，萬事方能順遂。誠心祈求，必有感應。</p>
                            </div>
                        </div>
                        <button onClick={() => setPage('card')} className="w-full max-w-lg bg-[#b45309] text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 mb-10"><Icons.Camera /> 領取福卡</button>
                    </div>
                );
            }

            if (page === 'card') {
                const poem = getPoem(lotNumber);
                return (
                    <div className="min-h-screen bg-black p-4 flex flex-col items-center overflow-y-auto">
                        <MuteButton isMuted={isMuted} toggleMusic={toggleMusic} />
                        <div ref={cardRef} data-card-body className="w-full max-w-[360px] rounded-[24px] overflow-hidden bg-black border border-amber-600/30 flex-shrink-0">
                            <div className="card-top bg-gradient-to-b from-[#d32f2f] to-[#8b0000] p-10 flex flex-col items-center">
                                <div className="logo-circle w-28 h-28 rounded-full border-2 border-amber-400/30 flex items-center justify-center mb-8 p-3 bg-white/5"><Icons.MountainLogo className="w-full h-full" /></div>
                                <div className="title-section text-center font-black space-y-1">
                                    <h2 className="text-xl text-white">一馬當先新開運</h2>
                                    <h2 className="text-xl text-amber-400">萬事順風到終局</h2>
                                </div>
                            </div>
                            <div className="card-bottom bg-[#fcfaf2] p-8 pb-12 paper-texture">
                                <div className="text-[10px] text-red-800 font-bold mb-6 text-center tracking-[0.2em]">— 崇正寶宮 —</div>
                                <div className="poetry-box bg-white/50 p-8 rounded-xl border border-stone-200 backdrop-blur-sm min-h-[160px] flex flex-col justify-center gap-4">
                                    {poem.map((line, i) => <JustifiedText key={i} text={line} poetryLine className="text-2xl font-bold text-red-950" />)}
                                </div>
                                <div className="card-footer flex justify-between items-end mt-12">
                                    <div className="flex flex-col gap-4">
                                        <div className="qr-container bg-white p-1.5 rounded-sm shadow-sm">
                                            <QrCodeGenerator value={window.location.href} size={70} />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-[10px] opacity-50 font-bold uppercase">Auth Date</span>
                                            <span className="auth-date-text text-lg font-black text-stone-900">{currentDate}</span>
                                        </div>
                                    </div>
                                    <div className="card-seal w-20 h-20 bg-red-700 p-2 flex flex-wrap items-center justify-center text-white seal-font leading-none text-center shadow-md border border-white/20 transform rotate-1">
                                        <div className="w-1/2">崇</div><div className="w-1/2">正</div>
                                        <div className="w-1/2">寶</div><div className="w-1/2">宮</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="mt-8 flex flex-col w-full max-w-[320px] gap-4 mb-10">
                            <button onClick={downloadCard} disabled={isDownloading} className="bg-[#b45309] text-white py-4 rounded-full font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all">
                                <Icons.Download /> {isDownloading ? '生成中...' : '下載福卡圖片'}
                            </button>
                            <button onClick={() => {setPage('home'); setLotNumber('');}} className="text-stone-400 font-bold py-2 flex items-center justify-center gap-2"><Icons.RefreshCw /> 再求一支</button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
