<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>金馬鴻運聚福堂 - 崇正寶宮靈籤</title>
    <!-- 基礎依賴 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 修正：加入 html2canvas 與 qrcode 函式庫 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Serif TC', serif; background-color: #2d0a0a; margin: 0; }
        .wood-texture { background-color: #a52a2a; background-image: repeating-linear-gradient(90deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 2px, transparent 2px, transparent 50px); box-shadow: inset 0 0 120px rgba(0,0,0,0.7); }
        .gate-stud { width: 14px; height: 14px; background: radial-gradient(circle at 35% 35%, #fbbf24, #b45309); border-radius: 50%; box-shadow: 2px 2px 5px rgba(0,0,0,0.7); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK 載入與初始化 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc, collection };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc } = window.FirebaseSDK;

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; 

        const QrCodeGenerator = ({ value, size = 100 }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && value && window.qrcode) {
                    try {
                        const qr = qrcode(0, 'M');
                        qr.addData(value);
                        qr.make();
                        containerRef.current.innerHTML = qr.createImgTag(5, 10);
                        const img = containerRef.current.querySelector('img');
                        if (img) {
                            img.style.width = `${size}px`;
                            img.style.height = `${size}px`;
                            img.className = "rounded-sm border border-stone-300 mx-auto";
                        }
                    } catch (e) { console.error("QR Error:", e); }
                }
            }, [value, size]);
            return <div ref={containerRef} />;
        };

        const Icons = {
            Sparkles: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/></svg>,
            Brain: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-2.54Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-2.54Z"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        };

        const fortuneData = {
            "1": ["欲成精金美玉品", "須向烈火焠煉真", "思立驚天動地業", "須懷慎終如始心"],
            "2": ["渡海浮囊一針差", "千里堤堰一蟻沙", "念頭雖微物縱恣", "高聳德業一夕塌"],
            "3": ["閒時常省言行合", "忙處為事自少過", "靜時常守元神住", "動中起念必不脫"],
            "4": ["世態炎涼無倚偏", "世味濃淡無欣厭", "如水隨方而就圓", "融通得體自在安"],
            "5": ["昨日之非莫留遺", "塵情必累自性地", "今日之是莫執拘", "真性反轉慾念及"],
            "101": ["縱情逐物事紛擾", "放下萬緣一步超"]
        };
        for (let i = 6; i <= 100; i++) {
            if (!fortuneData[i.toString()]) fortuneData[i.toString()] = [`這是第 ${i} 號靈籤內容`, "誠心修辦廣結善緣", "萬事順遂平安喜樂", "崇正寶宮祝福您"];
        }

        const JustifiedText = ({ text, className }) => (
            <div className={`flex justify-between w-full select-none ${className}`}>
                {text.split("").map((char, i) => <span key={i}>{char}</span>)}
            </div>
        );

        function App() {
            const [page, setPage] = useState('home');
            const [lotNumber, setLotNumber] = useState('');
            const [currentDate, setCurrentDate] = useState('');
            const [user, setUser] = useState(null);
            const [shareUrl, setShareUrl] = useState('');
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isDownloading, setIsDownloading] = useState(false);
            const [sharedImage, setSharedImage] = useState(null);
            
            const cardRef = useRef(null);

            useEffect(() => {
                const today = new Date();
                setCurrentDate(`${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);

                const params = new URLSearchParams(window.location.search);
                const shareId = params.get('share');
                if (shareId) {
                    const loadShared = async () => {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shares', shareId);
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            setSharedImage(snap.data().image);
                            setPage('viewer');
                        }
                    };
                    loadShared();
                }
                return () => unsubscribe();
            }, []);

            const saveAndGetUrl = async () => {
                if (!user || !cardRef.current || !window.html2canvas) return;
                try {
                    // 等待渲染穩定
                    await new Promise(r => setTimeout(r, 300));
                    const canvas = await html2canvas(cardRef.current, { scale: 2, useCORS: true });
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    const shareId = crypto.randomUUID();
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shares', shareId);
                    await setDoc(docRef, {
                        image: base64,
                        lotNumber: lotNumber,
                        createdAt: new Date().toISOString()
                    });
                    const url = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                    setShareUrl(url);
                } catch (e) { console.error("Cloud Save Error:", e); }
            };

            useEffect(() => {
                if (page === 'card' && !shareUrl && user) {
                    saveAndGetUrl();
                }
            }, [page, user]);

            const analyzePoem = async () => {
                setIsAnalyzing(true);
                const poem = fortuneData[lotNumber].join('，');
                const prompt = `你是一位慈悲的大師。請為我解釋崇正寶宮第${lotNumber}號靈籤：『${poem}』。請用溫暖且充滿智慧的語言寫約150字。`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setAiAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text || "大師正在禪定中。");
                } catch (e) { setAiAnalysis("目前無法連線。"); }
                setIsAnalyzing(false);
            };

            const downloadCard = async () => {
                if (!window.html2canvas) return;
                setIsDownloading(true);
                try {
                    const canvas = await html2canvas(cardRef.current, { scale: 3, useCORS: true });
                    const link = document.createElement('a');
                    link.download = `崇正福卡-${lotNumber}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                } finally { setIsDownloading(false); }
            };

            if (page === 'viewer') return (
                <div className="min-h-screen bg-stone-900 flex flex-col items-center justify-center p-4">
                    <img src={sharedImage} className="max-w-full rounded-3xl shadow-2xl border-4 border-amber-600/30" alt="Shared Card" />
                    <button onClick={() => window.location.href = window.location.origin + window.location.pathname} className="mt-8 bg-amber-600 text-white px-8 py-4 rounded-full font-bold shadow-lg">我也要抽籤</button>
                </div>
            );

            if (page === 'home') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-white text-center">
                    <h1 className="text-7xl font-black mb-2">金馬鴻運</h1>
                    <h2 className="text-4xl text-amber-500 tracking-widest mb-12">聚福堂</h2>
                    <div className="bg-black/40 p-8 rounded-2xl border border-amber-500/30 w-full max-w-sm backdrop-blur-md">
                        <input type="number" placeholder="輸入籤號 (1-101)" className="w-full bg-stone-900 text-center text-3xl py-4 rounded mb-6 text-amber-100 border border-amber-900 focus:outline-none focus:border-amber-500" value={lotNumber} onChange={(e) => setLotNumber(e.target.value)} />
                        <button onClick={() => { if(lotNumber) { setPage('door'); setTimeout(() => setPage('result'), 2800); }}} className="w-full bg-amber-600 py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg"><Icons.Sparkles /> 開啟鴻運</button>
                    </div>
                </div>
            );

            if (page === 'door') return (
                <div className="fixed inset-0 bg-black flex z-[100] overflow-hidden" style={{ perspective: '2000px' }}>
                    <style>{`
                        @keyframes swing-l { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(-115deg); } }
                        @keyframes swing-r { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(115deg); } }
                    `}</style>
                    <div className="w-1/2 h-full wood-texture border-r border-black/50 origin-left" style={{animation: 'swing-l 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards', animationDelay: '0.2s'}}>
                        <div className="h-full flex flex-col justify-around items-end pr-8 py-20">{Array(6).fill(0).map((_, i) => <div key={i} className="gate-stud"/>)}</div>
                    </div>
                    <div className="w-1/2 h-full wood-texture border-l border-black/50 origin-right" style={{animation: 'swing-r 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards', animationDelay: '0.2s'}}>
                        <div className="h-full flex flex-col justify-around items-start pl-8 py-20">{Array(6).fill(0).map((_, i) => <div key={i} className="gate-stud"/>)}</div>
                    </div>
                </div>
            );

            if (page === 'result') {
                const poem = fortuneData[lotNumber] || [];
                return (
                    <div className="min-h-screen bg-[#f4f3ed] p-6 flex flex-col items-center overflow-y-auto font-serif">
                        <div className="w-full max-w-lg bg-white rounded-3xl shadow-2xl border border-stone-200 overflow-hidden">
                            <div className="bg-red-800 p-8 text-center text-white">
                                <div className="text-sm opacity-80 mb-1 tracking-widest">崇正寶宮</div>
                                <div className="text-3xl font-black">靈籤第 {lotNumber} 號</div>
                            </div>
                            <div className="p-10 space-y-5">
                                {poem.map((line, i) => <JustifiedText key={i} text={line} className="text-3xl font-bold text-stone-900" />)}
                            </div>
                            {aiAnalysis && <div className="bg-amber-50 m-6 p-6 rounded-2xl border border-amber-200 text-amber-900 leading-relaxed italic">{aiAnalysis}</div>}
                        </div>
                        <div className="mt-8 w-full max-w-lg space-y-4 pb-12">
                            {!aiAnalysis && <button onClick={analyzePoem} disabled={isAnalyzing} className="w-full bg-stone-800 text-white py-4 rounded-full font-bold flex items-center justify-center gap-2">{isAnalyzing ? "正在連線..." : "請大師開示"}</button>}
                            <button onClick={() => setPage('card')} className="w-full bg-amber-700 text-white py-4 rounded-full font-bold shadow-lg active:scale-95 transition-all">領取個人福卡</button>
                        </div>
                    </div>
                );
            }

            if (page === 'card') {
                const poem = fortuneData[lotNumber] || [];
                return (
                    <div className="min-h-screen bg-stone-950 p-6 flex flex-col items-center overflow-y-auto font-serif">
                        <div ref={cardRef} className="w-full max-w-[360px] bg-[#fcfaf2] rounded-[40px] overflow-hidden p-6 border-[12px] border-double border-amber-700 shadow-2xl">
                            <div className="bg-gradient-to-b from-[#b91c1c] to-[#7f1d1d] rounded-3xl p-8 mb-6 text-center border-2 border-amber-400/30">
                                <div className="w-12 h-12 rounded-full bg-white/10 mx-auto mb-3 border border-amber-400 flex items-center justify-center text-white text-[10px] font-bold">崇正</div>
                                <h2 className="text-lg text-amber-200 font-black tracking-widest mb-1">一馬當先新開運</h2>
                                <h2 className="text-lg text-white font-black tracking-widest">萬事順風到終局</h2>
                            </div>
                            <div className="p-6 rounded-2xl border border-stone-200 shadow-inner bg-[#fcfaf2]">
                                <div className="text-center text-red-800 font-bold mb-5 tracking-[0.2em] text-[10px]">— 崇正寶宮 第 {lotNumber} 號靈籤 —</div>
                                <div className="space-y-4 mb-8">
                                    {poem.map((line, i) => <JustifiedText key={i} text={line} className="text-2xl font-black text-stone-900" />)}
                                </div>
                                <div className="flex justify-between items-end border-t pt-6">
                                    <div className="space-y-4 min-w-[85px]">
                                        {shareUrl ? <QrCodeGenerator value={shareUrl} size={85} /> : <div className="w-[85px] h-[85px] bg-stone-100 animate-pulse rounded border border-stone-200 flex items-center justify-center text-[10px] text-stone-400">連線中...</div>}
                                        <div className="text-[10px] text-stone-800 font-black">{currentDate}</div>
                                    </div>
                                    <div className="w-16 h-16 bg-red-800 p-2 rounded-sm flex flex-wrap items-center justify-center text-white leading-none text-center shadow-lg border border-red-900 transform -rotate-2 font-black text-xl">
                                        <div className="w-1/2">崇</div><div className="w-1/2">正</div><div className="w-1/2">寶</div><div className="w-1/2">宮</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="mt-10 w-full max-w-[320px] space-y-4 pb-12">
                            <button onClick={downloadCard} disabled={isDownloading || !shareUrl} className="w-full bg-amber-600 text-white py-4 rounded-full font-bold flex items-center justify-center gap-2 shadow-xl active:scale-95 transition-all">
                                <Icons.Download /> {isDownloading ? "保存中..." : "下載福卡"}
                            </button>
                        </div>
                    </div>
                );
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
